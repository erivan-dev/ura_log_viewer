<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Logs V9 (Separado)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-color: #494848;
            --text-color: #ffffff;
            --accent-color: #007acc;
            --container-bg: #252526;
            --border-color: #3e3e42;
            --table-header: #333333;
            --table-row-even: #2a2a2a;
            --table-row-hover: #37373d;
        }


        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        .container {
            width: 95%;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            min-height: 90vh;
        }
        

        h2 {
                color: #fff;
                margin-top: 0;
                margin-bottom: 20px;
                font-size: 1.8em;
                border-bottom: 2px solid var(--accent-color);
                padding-bottom: 10px;
                text-align: center;
        }

        h3 {
            color: #fff;
            font-size: 1.8em;
                border-bottom: 2px solid var(--accent-color);
                padding-bottom: 10px;
                text-align: center;
        }

        textarea {
            width: 100%;
            height: 120px;
            background-color: #1e1e1e;
            color: #9cdcfe;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            font-family: 'Consolas', monospace;
            white-space: pre;
            overflow-x: auto;
            box-sizing: border-box;
            resize: vertical;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background-color: #005f9e;
        }

        button.secondary {
            background-color: #555;
        }

        button.secondary:hover {
            background-color: #666;
        }

        .table-wrapper {
            /* Removido flex-grow aqui para permitir múltiplos containers */
            overflow: auto;
            border: 1px solid var(--border-color);
            margin-top: 10px;
            border-radius: 8px; 
            background-color: #1e1e1e;
            flex-shrink: 0; /* Impede que o container único encolha */
        }
        
        #tableContainer {
            flex-grow: 1; /* Permite que a tabela principal ocupe o espaço restante */
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }

        th,
        td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            white-space: nowrap;
        }

        th {
            background-color: var(--table-header);
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: bold;
            color: #fff;
        }

        tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        tr:hover {
            background-color: var(--table-row-hover);
        }

                /* Estilo da Tabela Key-Value (Single Position) */
        #singleValueTableContainer table {
            border: none;
        }
        #singleValueTableContainer th {
            background-color: var(--table-header);
            text-transform: uppercase;
            font-weight: 600;
            color: #fff;
            border-right: none;
            position: static;
        }
        #singleValueTableContainer td {
            border-right: none;
        }
        #singleValueTableContainer td:first-child {
            background-color: var(--table-header); 
            font-weight: bold;
            color: #fff;
            width: 35%; 
            min-width: 250px;
            text-transform: capitalize;
            position: static; 
        }

        /* Estilo para a primeira coluna da tabela de multi-posição */
        #tableContainer td:first-child,
        #tableContainer th:first-child {
            background-color: #2d2d2d;
            position: sticky;
            left: 0;
            z-index: 11;
            font-weight: bold;
            text-align: center;
            width: 40px;
            border-right: 2px solid #555;
        }

        #tableContainer th:first-child {
            z-index: 12;
        }
    </style>
</head>

<body>

    <div class="container">
        
        <h2>URA Log Viewer V1.10.1 </h2></br>
        <h5>Versionamento: major.minor.patch</h5></br>

        <textarea id="inputData" placeholder="Cole o log aqui...">
cod_identificacao_ligacao	689246577348
data_hora_inicio_ligacao	04/12/2025 10:47:29
event_name_1	inicio_menu|validacao_parametro|origem_identificada|saudacao_itau|validacao_parametro|validacao|inicio_menu|validacao_dma_habilitado|opm_dma_ddd_habilitado|validacao_origem_chamada|origem_transportes|direcionamento_fluxo|inicio_menu|acionamento_lacuna|mensagem_emergencial|direcionamento_fluxo|validacao|inicio_menu|validacao||
fluxo_1	Inicio_Ura_Seguros_Assistencias|Modulo_Dial_My_App|Inicio_Ura_Seguros_Assistencias|Roteador_Unico_Lacunas|Inicio_Ura_Seguros_Assistencias|Inicio_Identificacao_Publico||
id_ura	7
indicador_1	Abandono
input_1	||||||||||||||||||||
nome_ura	Seguros_Assistencia
ponto_1	10060|10583|10589|15599|10611|11769|24501|24502|24534|24505|10615|12035|10004|11014|11016|12001|11793|10009|11794||
ponto_origem_1	||||||||||||||||||||
produto_1	ITAU//NAO_DEFINIDO
qtd_duracao_em_segundos	24
range_1	10000|10500|10500|10000|10500|11500|24500|24500|24500|24500|10500|12000|10000|11000|11000|12000|10500|10000|10500||
tentativa_1	||||||||||||||||||||
timestamp_1	04/12/2025 10:47:31|04/12/2025 10:47:31|04/12/2025 10:47:31|04/12/2025 10:47:31|04/12/2025 10:47:34|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|04/12/2025 10:47:41|
timestamp_2	04/12/2025 10:47:53|
ultimo_ponto_1	11794
validacao_1	Itau_Seguros|Chamada_Autorizada|ITAU|Bom_Dia|Outras_Origens|Opm_Dma_Habilitado|Inicio_Ura_Seguros_Assistencias|Habilitado|Habilitado|Origem_Fixo|Identificacao_Publico|Direciona_Roteador_Lacunas|Inicio_Ura_Seguros_Assistencias|Primeiro_Acionamento|Mensagem_Emergencial_Desativada|Roteador_Unico_Lacunas|Outras_Origens|Inicio_Ura_Seguros_Assistencias|Origem_Uras_Relacionamento||
        </textarea>
        </br>
        <div class="controls">
             &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
            <button onclick="processarTabela()">Gerar Tabela</button>
             &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
            <button class="secondary" onclick="exportarCSV()">Baixar CSV (Excel)</button>
             &nbsp; &nbsp; 
            <button class="secondary" onclick="exportarPDF()">Baixar PDF</button>
             &nbsp; &nbsp; &nbsp; &nbsp;
        </div>

        <div class="table-wrapper" id="singleValueTableContainer" style="margin-top: 20px;">
            <h3 style="color:#fff; margin: 0 0 10px 0;">Variáveis de Posição Única (Metadados)</h3>
            <div style="padding:10px; color: #888;">As variáveis com apenas uma posição aparecerão aqui...</div>
        </div>

        <div class="table-wrapper" id="tableContainer">
            <h3 style="color:#fff; margin: 0 0 10px 0;">Fluxo Sequencial (Multi-Posição)</h3>
            <div style="padding:20px; color: #888;">A tabela aparecerá aqui...</div>
        </div>
        
        <footer style="margin-top: 30px; padding: 20px 0; text-align: center; border-top: 1px solid var(--border-color); color: #888; font-size: 0.9em;">
            Copyright © 2026 de Erivan Oliveira. Todos os direitos reservados.
        </footer>
    </div>

    <script>
        let colunasGlobal = [];

        function processarTabela() {
            const inputText = document.getElementById('inputData').value;
            const lines = inputText.split('\n');
            const grupos = {};
            const regex = /\s*(\w+?)(?:_(\d+))?\s+(.*)/;

            lines.forEach(line => {
                if (!line.trim()) return;
                const match = line.match(regex);

                if (match) {
                    const nomeBase = match[1];
                    const indice = match[2] ? parseInt(match[2], 10) : 0;
                    const conteudo = match[3].trim();

                    if (!grupos[nomeBase]) grupos[nomeBase] = [];
                    grupos[nomeBase].push({ idx: indice, text: conteudo });
                }
            });

            const dadosFinais = {};
            
            // 1. Processamento e Limpeza (Criação de dadosFinais)
            for (const [key, items] of Object.entries(grupos)) {
                items.sort((a, b) => a.idx - b.idx);
                const textoCompleto = items.map(item => item.text).join('');
                
                let arrayDeItens = textoCompleto.split('|').map(v => v.trim());

                // Remove o último item se for vazio (resultado de um pipe de terminação, ex: "a|b|")
                if (arrayDeItens.length > 0 && arrayDeItens[arrayDeItens.length - 1] === "") {
                    arrayDeItens.pop();
                }

                dadosFinais[key] = arrayDeItens;
            }


            // 2. Separação dos Dados em Single e Multi-Posição
            const dadosMultiPosicao = {};
            const dadosSinglePosicao = {};
            let maxItens = 0; // Para a tabela Multi-Posição

            for (const [key, arrayDeItens] of Object.entries(dadosFinais)) {
                // Considera posição única se o array tiver tamanho 1
                if (arrayDeItens.length === 1) {
                    dadosSinglePosicao[key] = arrayDeItens[0];
                } else if (arrayDeItens.length > 0) {
                    // Se for 0, ignora (limpeza final do arrayDeItens)
                    dadosMultiPosicao[key] = arrayDeItens;
                    if (arrayDeItens.length > maxItens) maxItens = arrayDeItens.length;
                }
            }


            // 3. Geração da Tabela de Posição Única (Key-Value)
            let htmlSingle = '<h3 style="color:#fff; margin: 0 0 10px 0;">Variáveis de Posição Única (Metadados)</h3><table><thead><tr><th>Variável</th><th>Valor</th></tr></thead><tbody>';
            
            // Ordena as chaves para melhor visualização
            Object.keys(dadosSinglePosicao).sort().forEach(key => {
                const valor = dadosSinglePosicao[key];
                htmlSingle += `<tr><td>${key}</td><td>${valor}</td></tr>`;
            });
            
            htmlSingle += '</tbody></table>';
            document.getElementById('singleValueTableContainer').innerHTML = htmlSingle;


            // 4. Geração da Tabela Principal (Multi-Posição) com Ordenação Customizada
            const ordemDesejada = [
                'event_name', 'validacao', 'fluxo', 'indicador', 
                'range', 'ponto', 'ultimo_ponto', 'input', 
                'tentativa', 'ponto_origem', 'timestamp'
            ];

            colunasGlobal = Object.keys(dadosMultiPosicao).sort((a, b) => {
                const indexA = ordemDesejada.indexOf(a);
                const indexB = ordemDesejada.indexOf(b);

                // Se ambos estiverem na lista, ordena pela posição na lista
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                // Se apenas A estiver na lista, A vem primeiro
                if (indexA !== -1) return -1;
                // Se apenas B estiver na lista, B vem primeiro
                if (indexB !== -1) return 1;
                // Se nenhum estiver na lista, ordena alfabeticamente no final
                return a.localeCompare(b);
            });

            let html = '<h3 style="color:#fff; margin: 0 0 10px 0;">Fluxo Sequencial (Multi-Posição)</h3><table><thead><tr><th>#</th>';
            colunasGlobal.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';

            for (let i = 0; i < maxItens; i++) {
                html += `<tr><td>${i + 1}</td>`;
                colunasGlobal.forEach(col => {
                    const valor = dadosMultiPosicao[col][i] !== undefined ? dadosMultiPosicao[col][i] : '';
                    html += `<td>${valor}</td>`;
                });
                html += '</tr>';
            }
            html += '</tbody></table>';

            document.getElementById('tableContainer').innerHTML = html;

            // 5. Adiciona evento de clique nas linhas da tabela principal
            const linhas = document.querySelectorAll("#tableContainer tbody tr");
            linhas.forEach(linha => {
                linha.addEventListener("click", () => {
                    linhas.forEach(l => l.style.backgroundColor = "");
                    linha.style.backgroundColor = getComputedStyle(document.documentElement)
                        .getPropertyValue('--accent-color');
                });
            });
        }

        function exportarCSV() {
            const tableMulti = document.querySelector("#tableContainer table");
            const tableSingle = document.querySelector("#singleValueTableContainer table");
            
            if (!tableMulti && !tableSingle) {
                alert("Gere a tabela primeiro!");
                return;
            }
            
            let csvContent = "";
            
            // Adiciona a Tabela Single (Key-Value)
            if (tableSingle) {
                csvContent += "--- METADADOS ---\n";
                const rowsSingle = tableSingle.querySelectorAll("tbody tr");
                rowsSingle.forEach(row => {
                    const cells = Array.from(row.querySelectorAll("td")).map(td => `"${td.innerText}"`);
                    csvContent += cells.join(";") + "\n";
                });
                csvContent += "\n";
            }
            
            
            if (tableMulti) {
                csvContent += "--- FLUXO SEQUENCIAL ---\n";
                const headers = Array.from(tableMulti.querySelectorAll("th")).map(th => th.innerText);
                csvContent += headers.join(";") + "\n";

                const rowsMulti = tableMulti.querySelectorAll("tbody tr");
                rowsMulti.forEach(row => {
                    const cells = Array.from(row.querySelectorAll("td")).map(td => `"${td.innerText}"`);
                    csvContent += cells.join(";") + "\n";
                });
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "analise_log.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportarPDF() {
            const tableMulti = document.querySelector("#tableContainer table");
            const tableSingle = document.querySelector("#singleValueTableContainer table");
            
            if (!tableMulti && !tableSingle) {
                alert("Gere a tabela primeiro!");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Orientação paisagem
            
            let yPosition = 15;

            // Título do documento
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Análise de Logs - Organizador V7', 15, yPosition);
            yPosition += 10;

            // Tabela de Metadados (Single Position)
            if (tableSingle) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Variáveis de Posição Única (Metadados)', 15, yPosition);
                yPosition += 5;

                const dataSingle = [];
                const rowsSingle = tableSingle.querySelectorAll("tbody tr");
                rowsSingle.forEach(row => {
                    const cells = Array.from(row.querySelectorAll("td")).map(td => td.innerText);
                    dataSingle.push(cells);
                });

                doc.autoTable({
                    startY: yPosition,
                    head: [['Variável', 'Valor']],
                    body: dataSingle,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 122, 204], textColor: 255, fontStyle: 'bold' },
                    styles: { fontSize: 8, cellPadding: 2 },
                    columnStyles: {
                        0: { cellWidth: 60, fontStyle: 'bold' },
                        1: { cellWidth: 'auto' }
                    }
                });

                yPosition = doc.lastAutoTable.finalY + 10;
            }

            // Tabela de Fluxo Sequencial (Multi-Position)
            if (tableMulti) {
                // Verifica se precisa de nova página
                if (yPosition > 180) {
                    doc.addPage();
                    yPosition = 15;
                }

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Fluxo Sequencial (Multi-Posição)', 15, yPosition);
                yPosition += 5;

                const headersMulti = Array.from(tableMulti.querySelectorAll("th")).map(th => th.innerText);
                const dataMulti = [];
                const rowsMulti = tableMulti.querySelectorAll("tbody tr");
                rowsMulti.forEach(row => {
                    const cells = Array.from(row.querySelectorAll("td")).map(td => td.innerText);
                    dataMulti.push(cells);
                });

                doc.autoTable({
                    startY: yPosition,
                    head: [headersMulti],
                    body: dataMulti,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 122, 204], textColor: 255, fontStyle: 'bold' },
                    styles: { fontSize: 7, cellPadding: 1.5, overflow: 'linebreak' },
                    columnStyles: {
                        0: { cellWidth: 10, halign: 'center', fontStyle: 'bold' }
                    },
                    margin: { left: 10, right: 10 }
                });
            }

            // Adiciona rodapé com data/hora
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text(
                    `Gerado em: ${new Date().toLocaleString('pt-BR')} - Página ${i} de ${pageCount}`,
                    15,
                    doc.internal.pageSize.height - 10
                );
            }

            doc.save('analise_log.pdf');
        }
    </script>


</body>

</html>
